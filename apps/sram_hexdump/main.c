#include <stdint.h>
#include <util/delay.h>
#include <string.h>
#include <stdio.h>
#include "../../config/pin_bus.h"
#include "../../lib/uart/uart.h"
#include "../../lib/sram_gpio/sram_gpio.h"
#include "../../lib/sram_read/sram_read.h"
#include "../../lib/sram_write/sram_write.h"

uint8_t program[][16] = {
    0xa9, 0xff, 0x8d, 0x02, 0x60, 0xa9, 0xe0, 0x8d, 0x03, 0x60, 0xa9, 0x38, 0x8d, 0x00, 0x60, 0xa9,
    0x00, 0x8d, 0x01, 0x60, 0xa9, 0x80, 0x8d, 0x01, 0x60, 0xa9, 0x00, 0x8d, 0x01, 0x60, 0xa9, 0x0e,
    0x8d, 0x00, 0x60, 0xa9, 0x00, 0x8d, 0x01, 0x60, 0xa9, 0x80, 0x8d, 0x01, 0x60, 0xa9, 0x00, 0x8d,
    0x01, 0x60, 0xa9, 0x06, 0x8d, 0x00, 0x60, 0xa9, 0x00, 0x8d, 0x01, 0x60, 0xa9, 0x80, 0x8d, 0x01,
    0x60, 0xa9, 0x00, 0x8d, 0x01, 0x60, 0xa9, 0x01, 0x8d, 0x00, 0x60, 0xa9, 0x00, 0x8d, 0x01, 0x60,
    0xa9, 0x80, 0x8d, 0x01, 0x60, 0xa9, 0x00, 0x8d, 0x01, 0x60, 0xa9, 0x43, 0x20, 0x76, 0x80, 0xa9,
    0x69, 0x20, 0x76, 0x80, 0xa9, 0x61, 0x20, 0x76, 0x80, 0xa9, 0x6f, 0x20, 0x76, 0x80, 0xa9, 0x21,
    0x20, 0x76, 0x80, 0x4c, 0x92, 0x80, 0x8d, 0x00, 0x60, 0xa9, 0x20, 0x8d, 0x01, 0x60, 0xa9, 0xa0,
    0x8d, 0x01, 0x60, 0xa9, 0x20, 0x8d, 0x01, 0x60, 0x60, 0xa6, 0x00, 0x20, 0x8f, 0x80, 0x60, 0xa4,
    0x01, 0x60, 0xa9, 0x31, 0x20, 0x76, 0x80, 0x20, 0x89, 0x80, 0x4c, 0x92, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  };
  

void setup_pins ();
void inject_program ();
void sram_fetch ();
void end_pins ();

int main ()
{
    UART_init ();
    UART_putString ("\n\n----------- HEXDUMP -----------\n");
    setup_pins();
    _delay_ms (1000);
    inject_program ();
    _delay_ms (1000);
    sram_fetch ();
}

void setup_pins ()
{
    for (int i = 0; i < 15; i++)
        avr_pin_mode (ADDR_PINS[i], OUTPUT);
    for (int i = 0; i < 8; i++)
        avr_pin_mode (DATA_PINS[i], INPUT);
  
  // ram not selected (cs active low)
  avr_pin_mode (CS_PIN, OUTPUT);
  avr_digital_write (CS_PIN, HIGH);
  avr_pin_mode (WE_PIN, OUTPUT);
  avr_digital_write (WE_PIN, HIGH);
  avr_pin_mode (OE_PIN, OUTPUT);
  avr_digital_write (OE_PIN, HIGH);
}

void end_pins ()
{
    avr_digital_write (CS_PIN, HIGH);
    avr_pin_mode (OE_PIN, INPUT);
    avr_pin_mode (WE_PIN, INPUT);

    for (int i = 0; i < 15; i++)
        avr_pin_mode (ADDR_PINS[i], INPUT);
    for (int i = 0; i < 8; i++)
        avr_pin_mode (DATA_PINS[i], INPUT);
}

void inject_program ()
{ 
    UART_putString ("Injecting program...");
    uint16_t addr = 0;
    int i, j;

    for (i = j = addr = 0; addr < sizeof (program); addr++, j++)
    {
        if (j == 0x10)
        {
            j = 0;
            i++;
        }
        data_write (addr, program[i][j]);
    }

//  reset vector at location fffc (lb) fffd (hb)
//  data_write (0x7ffc, 0x00);
//  data_write (0x7ffd, 0x80);

    UART_putString ("complete...integity check...");

    for (addr = i = j = 0; addr < sizeof (program); addr++, i++)
    {   
        if (i == 0x10)
        {
            i = 0; 
            j++;
        } 
        if (program[j][i] != data_read (addr))
        {
            UART_putString ("ERROR");
            return ;
        } 
    }
    UART_putString ("success.");
} 

void sram_fetch ()
{
    UART_putString ("\nhexdump ");

    char buf[30];
    snprintf (buf, sizeof (buf), "program size: %d bytes\n", sizeof (program));
    UART_putString (buf);

    char header[] = "\nAddress: 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n";
    UART_putString (header);

    uint16_t addr = 0;
    int i, j;

    for (addr = 0; addr < sizeof (program);)
    {
        sprintf (buf, "%07x: ", addr);
        UART_putString (buf);
        for (i = 0; i < 16; i++)
        {
            uint8_t data = data_read (addr++);
            sprintf (buf, "%02x ", data);
            UART_putString (buf);
        }
        UART_putString ("\n");
    }
}
